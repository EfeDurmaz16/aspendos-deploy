# YULA OS CI/CD Pipeline
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: '1.1.0'
  NODE_VERSION: '20'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma Client
        run: cd packages/db && bunx prisma generate

      - name: Type check API
        run: cd services/api && bunx tsc --noEmit
        continue-on-error: true

      - name: Type check Web
        run: cd apps/web && bun run typecheck
        continue-on-error: false

      - name: Biome check
        run: bun biome check apps/web services/api packages/db
        continue-on-error: true

  # ============================================
  # SECURITY SCAN
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for known vulnerabilities
        run: bun audit 2>/dev/null || true

      - name: Scan for hardcoded secrets
        run: |
          echo "Scanning for hardcoded secrets..."
          FOUND=0
          for pattern in "sk-[a-zA-Z0-9]{20,}" "ghp_[a-zA-Z0-9]{36}" "AKIA[0-9A-Z]{16}" "-----BEGIN.*PRIVATE KEY-----"; do
            if grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" -E "$pattern" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null | grep -v "test" | grep -v "example" | grep -v ".env.example"; then
              echo "WARNING: Potential secret found matching pattern"
              FOUND=1
            fi
          done
          if [ $FOUND -eq 1 ]; then
            echo "::warning::Potential secrets detected in codebase"
          else
            echo "No hardcoded secrets detected."
          fi

      - name: Check for .env files in repo
        run: |
          if find . -name ".env" -not -path "*/node_modules/*" -not -name ".env.example" -not -name ".env.local.example" | grep -q .; then
            echo "::error::Found .env files committed to repository!"
            exit 1
          fi
          echo "No .env files found in repository."

  # ============================================
  # TEST WITH COVERAGE
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: yula_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma Client
        run: cd packages/db && bunx prisma generate

      - name: Run API tests
        run: cd services/api && bun run test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/yula_test
          NODE_ENV: test
          JWT_SECRET: test-secret-key-for-testing-only
          BETTER_AUTH_SECRET: test-better-auth-secret-key

      - name: Run Web tests
        run: cd apps/web && bun run test
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

      - name: Run AI SDK Router tests
        run: cd apps/web && bun run test:router
        env:
          OPENAI_API_KEY: test-key
          ANTHROPIC_API_KEY: test-key
          GROQ_API_KEY: test-key

  # ============================================
  # BUILD
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate Prisma Client
        run: cd packages/db && bunx prisma generate

      - name: Build API
        run: cd services/api && bun run build

      - name: Build Web
        run: cd apps/web && bun run build
        env:
          NEXT_PUBLIC_API_URL: https://api.yula.dev
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

  # ============================================
  # DATABASE MIGRATION CHECK
  # ============================================
  migration-check:
    name: Database Migration Check
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: yula_migration_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate Prisma schema
        run: cd packages/db && bunx prisma validate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/yula_migration_test

      - name: Push schema to test database
        run: cd packages/db && bunx prisma db push --accept-data-loss
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/yula_migration_test

      - name: Generate Prisma Client
        run: cd packages/db && bunx prisma generate

  # ============================================
  # DEPLOY TO VERCEL (Preview)
  # ============================================
  deploy-preview:
    name: Deploy Preview to Vercel
    runs-on: ubuntu-latest
    needs: [build, test, security]
    if: github.event_name == 'pull_request'
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Preview to Vercel
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> "$GITHUB_OUTPUT"

  # ============================================
  # DEPLOY TO VERCEL (Production)
  # ============================================
  deploy-production:
    name: Deploy Production to Vercel
    runs-on: ubuntu-latest
    needs: [build, test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://yula.dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Production to Vercel
        run: |
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          echo "YULA OS deployed to production"

      - name: Post-deploy health check
        run: |
          sleep 30
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.yula.dev/health || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed"
          else
            echo "::warning::Health check returned $STATUS"
          fi
